import React, { Component } from 'react';
import { Classes, Tree, ITreeNode, ButtonGroup, Button, Popover, Position, PopoverInteractionKind, Menu, MenuItem, ContextMenu, Icon, InputGroup, Intent} from '@blueprintjs/core';
import * as exploitTypes from '../../../models/exploit';
import LeftAddMenu from './LeftAddMenu';
import classNames from 'classnames';
import {List} from 'immutable';
import {leftData} from '../../../models/exploit';
type propTypes = {
    height: number;
    leftMainWidth: number;
    leftSwitch: string;
    leftDataTree: List<leftData | {}>;
    expandLeftMenu: (leftData: List<leftData | {}>, leftSwitch: string) => void;
    changeOpen: (stateName: string, isOpen: boolean ) => void;
    boardList: List<any>;
    switchBoardList: (activeBoardId: string, boardList: List<any>) => void;
    switchActiveBoardId: (activeBoardId: string) => void;
};

export interface ITreeExampleState {
    showSearch: boolean;
}

const firstRightMenu = (
    <Menu>
        <MenuItem text={'新建离线任务'} />
        <MenuItem text={'删除工作流'} />
        <MenuItem text={'重命名'} />
    </Menu>);
const secondRightMenu = (
    <Menu>
        <MenuItem text={'新建目录'} />
        <MenuItem text={'新建离线任务'} />
    </Menu>);

class LeftMain extends Component<propTypes, ITreeExampleState> {

    constructor(props: propTypes) {
        super(props);
        this.state = {showSearch: false};
    }

    showName = (name: string, id: string) => {
        const {boardList, leftSwitch} = this.props;
        const isOpen = boardList.filter((item) => {
            return item.id === `${leftSwitch}#${id}`;
        }).size > 0;
        return (
            <div>
                <span style={isOpen ? {color: '#48AFF0'} : {color: '#182026'}}>{name}</span>
                <div className={'tree-right'}>
                    <Popover content={id ? secondRightMenu : firstRightMenu} position={Position.RIGHT} interactionKind={PopoverInteractionKind.HOVER}>
                        <Icon title="操作" className={'more'} icon={'more'}/>
                    </Popover>
                </div>
            </div>);
    };

    LOOP_DATA: any = (data: List<exploitTypes.leftData> , id: string) => data.map((item: exploitTypes.leftData, index) => {
        // @ts-ignore
        return {id: id ? `${id}-${index}` : index + '', key: id ? `${id}-${index}` : index + '', icon: (<Icon className={'tree-icon'} style={item.color ? {color: item.color} : {color: '#5c7080'}} icon={item.icon} />)
            , hasCaret: true, isExpanded: item.isExpanded
            , label: this.showName(item.name, id ? `${id}-${index}` : index + ''), childNodes: this.LOOP_DATA(item.children, id ? `${id}-${index}` : index + '') };
    });

    handleNodeContextMenu = (nodeData: ITreeNode, _nodePath: number[] , e: React.MouseEvent<HTMLElement>) => {
        const idLength = (nodeData.id + '').split('-').length;
        ContextMenu.show(
            idLength === 1 ? firstRightMenu : secondRightMenu,
            {left: e.clientX, top: e.clientY}
        );
        e.preventDefault();
        e.stopPropagation();
    };

    handleNodeExpand = (nodeData: ITreeNode, _nodePath: number[]) => {
        const {leftDataTree, expandLeftMenu, leftSwitch} = this.props;
        const paths = _nodePath.join(',children,').split(',');
        const newLeftData = leftDataTree.updateIn([...paths, 'isExpanded'], value => true);
        expandLeftMenu(newLeftData, leftSwitch);
    };

    handleNodeCollapse = (nodeData: ITreeNode, _nodePath: number[]) => {
        const {leftDataTree, expandLeftMenu, leftSwitch} = this.props;
        const paths = _nodePath.join(',children,').split(',');
        const newLeftData = leftDataTree.updateIn([...paths, 'isExpanded'], value => false);
        expandLeftMenu(newLeftData, leftSwitch);
    };

    handleNodeDoubleClick = (nodeData: ITreeNode, _nodePath: number[]) => {
        const {switchBoardList, leftSwitch, boardList, switchActiveBoardId} = this.props;
        if (typeof nodeData.label !== 'string') {
            const isOpen = boardList.filter((item) => {
                return item.id === `${leftSwitch}#${nodeData.id}`;
            }).size > 0;
            if (isOpen) {
                switchActiveBoardId(`${leftSwitch}#${nodeData.id}`);
            } else {
                const newBoradMap = boardList.insert(boardList.size + 1, {name: nodeData.label.props.children[0].props.children, icon: nodeData.icon, id: `${leftSwitch}#${nodeData.id}`});
                switchBoardList(`${leftSwitch}#${nodeData.id}`, newBoradMap);
            }
        }
    };

    render() {
        const {height, leftMainWidth, leftDataTree, changeOpen} = this.props;
        const {showSearch} = this.state;
        const lockButton = (
            <Button
                icon={'search'}
                intent={Intent.PRIMARY}
                minimal={true}
            />
        );
        return (
            <div className={'left-main'} style={{height, width: leftMainWidth}}>
                <ButtonGroup className={'button-right'} style={showSearch ? {display: 'none'} : {display: 'inline'}}>
                    <Button key={'refresh'} small={true}  className={Classes.MINIMAL} icon={'refresh'} title={'刷新'} />
                    <Popover key={'add'}  modifiers={{arrow: {enabled: false}}} content={<LeftAddMenu changeOpen={changeOpen}/>} position={Position.BOTTOM} interactionKind={PopoverInteractionKind.HOVER}>
                        <Button small={true} className={Classes.MINIMAL} icon={'add'} />
                    </Popover>
                    <Button key={'search'} small={true} className={Classes.MINIMAL} icon={'search'} title={'查询'} onClick={() => this.setState({showSearch: true})}  />
                </ButtonGroup>
                <div  className={classNames({ 'input-right': true, 'active': showSearch})}>
                    <InputGroup  onBlur={() => this.setState({showSearch: false})} placeholder="搜索条件" small={true} rightElement={lockButton} type={'text'}/>
                </div>
                <div style={{marginTop: 30}}>
                    <Tree
                        contents={this.LOOP_DATA(leftDataTree, '').toJS()}
                        className={Classes.ELEVATION_0}
                        // onNodeClick={this.handleNodeClick}
                        onNodeExpand={this.handleNodeExpand}
                        onNodeCollapse={this.handleNodeCollapse}
                        onNodeContextMenu={this.handleNodeContextMenu}
                        onNodeDoubleClick={this.handleNodeDoubleClick}
                    />
                </div>
        </div>);
    }
}
export default LeftMain;
