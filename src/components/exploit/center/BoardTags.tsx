import React, { Component } from 'react';
import '../../../styles/exploit.scss';
import {Map, List} from 'immutable';
import {Icon} from '@blueprintjs/core';
import classNames from 'classnames';
import BoardTag from './BoardTag';

type propTypes = {
    rightWidth: number;
    boardMap: Map<string, any>;
    activeBoardId: string | null;
    transformX: number;
    flowTransformX: (transformX: number) => void;
    switchActiveBoardId: (activeBoardId: string) => void;
    updateBoardMap: (boardMap: Map<string, any>) => void;
};
type stateTypes = {
    boardMap: Map<string, any>;
    activeBoardId: string | null;
    rightWidth: number;
};

class BoardTags extends Component<propTypes, stateTypes> {
    // @ts-ignore
    get componentWillReceiveProps(): (nextProps: propTypes) => void {
        return this._componentWillReceiveProps;
    }

    set componentWillReceiveProps(value: (nextProps: propTypes) => void) {
        this._componentWillReceiveProps = value;
    }
    constructor(props: propTypes) {
        super(props);
        const {boardMap, activeBoardId, rightWidth} = this.props;
        this.state = { boardMap: boardMap, activeBoardId: activeBoardId, rightWidth: rightWidth };
    }

    componentDidMount() {
        const {boardMap, activeBoardId, rightWidth} = this.props;
        this.calculateFlow(boardMap, activeBoardId, rightWidth);
    }
    public _componentWillReceiveProps = (nextProps: propTypes) => {
        const {boardMap, activeBoardId, rightWidth} = this.state;
        if (nextProps.boardMap !== boardMap || nextProps.activeBoardId !== activeBoardId || nextProps.rightWidth !== rightWidth) {
            this.calculateFlow(nextProps.boardMap, nextProps.activeBoardId, nextProps.rightWidth);
        }
    };

    flowRight = () => {
        const {flowTransformX, boardMap, rightWidth} = this.props;
        const transformX = 140 * boardMap.size - (rightWidth - 18 * 2);
        flowTransformX(transformX);
    };

    flowLeft = () => {
        const {flowTransformX} = this.props;
        flowTransformX(0);
    };

    calculateFlow = (boardMap: Map<string, any>, activeBoardId: string | null, rightWidth: number) => {
        const {flowTransformX} = this.props;
        const boardIds: string [] = [];
        if ( activeBoardId ) {
            List(boardMap).map((tag) => {
                boardIds.push(tag[0]);
            });
            const index = boardIds.indexOf(activeBoardId);
            const transformX = 140 * (index + 1) - (rightWidth - 18 * 2 );
            if (transformX > 0 ) {
                flowTransformX(transformX);
            } else {
                flowTransformX(0);
            }
        }
        this.setState({boardMap: boardMap, activeBoardId: activeBoardId, rightWidth: rightWidth});
    };

    render() {
        const {rightWidth, boardMap, activeBoardId, transformX, switchActiveBoardId, updateBoardMap} = this.props;
        const tabWidth = 140;
        const needScroll = (boardMap.size * tabWidth) > (rightWidth - 40);
        const canFlowRight = (boardMap.size * tabWidth - (rightWidth - 18 * 2)) === transformX;
        return (
            <div className={'board-tags'} style={{width: rightWidth}}>
                {needScroll ? <span onClick={this.flowLeft} className={classNames('tabs-tab-prev', {disabled: transformX === 0})} ><Icon icon={'chevron-left'}/></span> : null}
                {needScroll ? <span onClick={this.flowRight} className={classNames('tabs-tab-next', {disabled: canFlowRight})} ><Icon icon={'chevron-right'}/></span> : null}
                <div style={{width: rightWidth - 36}} className={classNames('board-tabs-scroll', {hasScroller: needScroll})}>
                    <div className={'board-tab-wrapper'} style={{transform: `translate3d(-${transformX}px, 0px, 0px)`}}>
                        {List(boardMap).map((tag) => (
                            <BoardTag key={tag[0]} switchActiveBoardId={switchActiveBoardId} tagId={tag[0]} tagValue={tag[1]} boardMap={boardMap} updateBoardMap={updateBoardMap} className={classNames({active: tag[0] === activeBoardId})}/>
                            ))}
                    </div>
                </div>
        </div>);
    }
}
export default BoardTags;
